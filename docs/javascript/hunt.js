window.onload=e=>{const t=sessionStorage.getItem("user"),n=JSON.parse(t);let o="",s=[],r="";var a=[17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,34,35,36,37,38,39,40,41,42,43,44,45,48,49,50,53];let l="",c=0;const d=document.querySelectorAll(".rankIcon"),i=(document.getElementById("main"),document.getElementById("overlay"));var g=-1;const m={"Ancient Forest":1,"Wildspire Waste":3,"Coral Highlands":5,"Rotten Vale":7,"Elder's Recess":8};try{if(!t)return void(window.location.href="../html/login.html");n?(document.getElementById("authname").innerText=`Welcome ${n.name}`,console.log(`Welcomeeee ${n.name}`)):window.location.href="../html/login.html"}catch(e){console.error("error",e)}var u=document.getElementById("regionDropdown"),h=document.getElementById("regionButton"),p=(document.getElementsByClassName("regionOption"),document.getElementById("huntButton")),y=document.getElementById("huntOverlay"),w=document.getElementById("carousel"),f=0,E=[],v=document.getElementById("previousWeapon"),I=document.getElementById("nextWeapon"),b=document.getElementById("carouselNumber");document.addEventListener("click",(function(e){e.target===h&&(u.style.display="block"),e.target.classList.contains("regionOption")&&(r=e.target.textContent,h.textContent=r,u.style.display="none",g=m[r],console.log(g),-1!==g&&(document.getElementById("huntDiv").style.display="block"),d.forEach(((e,t)=>{e.src=t<g?"../icons/star-full.png":"../icons/star-empty.png"})))})),document.addEventListener("click",(function(e){e.target!==h&&(u.style.display="none")})),document.addEventListener("click",(function(e){if(e.target===p){i.style.display="block";const e=s[f],t=e.id;console.log("------------------"),async function(){try{var e=[];const t=a.map((async function(t){const n=await fetch(`https://mhw-db.com/monsters/${t}`),o=await n.json();e.push(o)}));await Promise.all(t);const n=e.filter((e=>e.locations.some((e=>e.name===r))));if(n.length>0){const e=Math.floor(Math.random()*n.length);l=n[e],console.log("Random Monster:",l.name)}else console.log("No monster found in selected region.")}catch(e){console.error("Error fetching monster data:",e)}}().then((async()=>{console.log(e);const n=e.rarity-g;if(1===e.elements.length){const t=e.elements[0].type;l.resistances.some((e=>e.element===t))?(console.log("resistant"),c=-20):(console.log("not resistant"),l.weaknesses.some((e=>3===e.stars&&e.element===t))?(c=20,console.log("is weak")):console.log("not weak, so neutral"))}const s=75+10*Math.random()+20*n+c;if(console.log("random:",s),s>100*Math.random()){console.log("succes"),function(){const e=document.getElementById("huntOverlay");let t=` <p class="huntResult">SUCCES</p>\n        <img class="overlayMonster" src="../icons/monsters/${l.name}.png" alt="">\n        <p class="huntMessage">You successfully hunted a</p>\n        <p class="rankMonster">${l.name}</p>`;e.innerHTML=t,i.appendChild(e)}();try{await fetch("https://web2-course-project.onrender.com/hunts").then((e=>e.json())).then((async t=>{let n=1e4;for(let e=1;e<=t.length+1;e++)if(!t.some((t=>t.HuntId===e))){n=e;break}let o={};o.UserId=k,o.GreatswordId=e.id,o.MonsterId=l.id,o.location=r,o.HuntId=n,await async function(e,t,n){try{const e=await fetch("https://web2-course-project.onrender.com/save_hunt",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});if(!e.ok)throw new Error(`Request failed with status: ${e.status}`);const t=await e.text();return console.log("Response Data:",t),t}catch(e){throw console.error("Error during API call",e),e}}(0,0,o).then((e=>{console.log(e)}))}))}catch(e){console.error("Error during saving hunt",e)}const n=e.crafting;if(n.branches&&n.branches.length>0){const e=Math.floor(Math.random()*n.branches.length),s=n.branches[e];console.log("Random Branch:",s);let r=null;for(let e=1;e<=o.length+1;e++)if(!o.some((t=>t.UserGreatswordId===e))){r=e;break}let a={};a.UserId=k,a.GreatswordId=s,a.UserGreatswordId=r,console.log(a);try{await async function(e,t,n){try{const e=await fetch("https://web2-course-project.onrender.com/save_user_greatsword",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});if(!e.ok)throw new Error(`Request failed with status: ${e.status}`);return e.text()}catch(e){throw console.error("Error during upgrade API call",e),e}}(0,0,a);const e=await fetch(`https://web2-course-project.onrender.com/delete_UGS_by_id?UserId=${k}&GreatswordId=${t}`,{method:"DELETE",headers:{"Content-Type":"application/json"}});e.ok?console.log("downgrade and removal succes"):console.log("Error during removal: HTTP status:",e.status),console.log("upgrade and removal complete")}catch(e){console.error("error during upgrade and removal",e)}}else console.log("No branches available.")}else{console.log("fail"),function(){const e=document.getElementById("huntOverlay");let t=`<p class="huntResult">FAIL</p>\n        <img class="overlayMonster" src="../icons/monsters/${l.name}.png" alt="">\n        <p class="huntMessage">You failed to hunted a</p>\n        <p class="rankMonster">?</p>`;e.innerHTML=t,i.appendChild(e)}();const n=e.crafting;if(n.previous){const e=n.previous;console.log("Previous weapon ID:",e);let s=null;for(let e=1;e<=o.length+1;e++)if(!o.some((t=>t.UserGreatswordId===e))){s=e;break}let r={};r.GreatswordId=e,r.UserGreatswordId=s,r.UserId=k,console.log(r);try{console.log("newUser_Greatsword",r),await async function(e,t,n){try{const e=await fetch("https://web2-course-project.onrender.com/save_user_greatsword",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});if(!e.ok)throw new Error(`Request failed with status: ${e.status}`);const t=await e.text();return console.log("Response Data:",t),t}catch(e){throw console.error("Error during API call",e),e}}(0,0,r);const e=await fetch(`https://web2-course-project.onrender.com/delete_UGS_by_id?UserId=${k}&GreatswordId=${t}`,{method:"DELETE"});e.ok?console.log("downgrade and removal succes"):console.log("Error during removal: HTTP status:",e.status),console.log("Downgrade and removal complete")}catch(e){console.error("Error during downgrade and removal",e),console.error("Error response:",e.response),console.error("Response data:",e.data)}}}}))}})),document.addEventListener("click",(function(e){e.target!=i||y.contains(e.target)||(i.style.display="none")})),v.addEventListener("click",(function(){--f<0&&(f=E.length-1),B(f)})),I.addEventListener("click",(function(){++f>=E.length&&(f=0),B(f)}));const k=n.UserId;function B(e){E.forEach(((t,n)=>{t.style.display=n===e?"block":"none"})),b.textContent=e+1+"/"+E.length}fetch("https://web2-course-project.onrender.com/user_greatswords").then((e=>e.json())).then((e=>{o=e.filter((function(e){return e.UserId===k})),o.sort(((e,t)=>e.GreatswordId-t.GreatswordId)),console.log(o),Object.keys(o).length,Promise.all(o.slice(0,88).map((e=>{const t=e.GreatswordId;return fetch(`https://mhw-db.com/weapons/${t}`).then((e=>e.json()))}))).then((e=>{s=e,e.forEach(((e,t)=>{const n=Object.keys(e.elements).length;let o=`<div class="slide${t+1}">\n                            <div class="greatsword gs1">\n                                <div class="gsInternal">\n                                    <div class="gsTop">\n                                        <p class="gsName">${e.name}<p>\n                                    </div>\n                                    <img class="gsIcon" src="../icons/greatswords/Greatsword${e.rarity}.png" alt="">\n                                    <div class="gsStatsLeft">\n                                        <p>Rarity:</p>\n                                        <p>Element:</p>\n                                    </div>\n                                    <div class="gsStatsRight">\n                                        <p class="gsAttack">${e.rarity}</p>\n                                        \n                                            <p class="gsElementDamage"></p>`;o+=1===n?`<img class="gsElement" src="../icons/elements/${e.elements[0].type}.png" alt="">`:'<p class="noElement">None</p>',o+="\n                                                    </div>\n                                                </div>";const s=document.createElement("div");s.classList.add("slide"),s.classList.add(`slide${t+1}`),s.innerHTML=o,w.appendChild(s)})),(E=document.querySelectorAll(".slide"))[f].style.display="block",B(f)}))})),document.getElementById("logoutButton").addEventListener("click",(function(){sessionStorage.removeItem("user"),window.location.assign("../html/login.html")}))};